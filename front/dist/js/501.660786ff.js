"use strict";(self["webpackChunkfront"]=self["webpackChunkfront"]||[]).push([[501],{67641:function(t,e,s){s.r(e),s.d(e,{default:function(){return st}});var a=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("work-task-ass-project",{attrs:{cards:t.$options.name,chatview:t.chatview,show:t.show,title:"Задача "+t.gettasks.name,breadcrumbs:t.breadcrumbs},on:{afterLeave:t.afterLeave,afterEnter:t.afterEnter,createnewWork:t.createnewWork,allCard:t.allCard},scopedSlots:t._u([{key:"spisok",fn:function(){return[s("left-list",{attrs:{level:2},on:{confirmation:t.confirmation,rout:t.rout}}),s("v-row",{staticClass:"flex-grow-0 "},[s("v-col",{staticClass:"pa-0"},[s("v-divider")],1)],1),s("v-row",{staticClass:"flex-grow-0 justify-end"},[s("v-col",{staticClass:"flex-grow-0"},[s("MyIco",{attrs:{size:"large",icons:"mdi-chart-gantt"},on:{click:t.gantviewer}})],1)],1),s("v-slide-x-reverse-transition",[s("v-card",{directives:[{name:"show",rawName:"v-show",value:t.gantview,expression:"gantview"}],staticClass:"gantPosition"},[s("gant-task",{ref:"ganttask",attrs:{startlevel:"task"},on:{saver:t.addTask,changegantview:t.changegantview}})],1)],1)]},proxy:!0},{key:"informations",fn:function(){return[s("informationorders",{attrs:{chat:t.activedCh,chatview:t.chatview,indx:0,level:2,breadcrumbs:t.breadcrumbs},on:{chatviewer:t.chatviewer,createtabchat:t.createtabchat,changestatus:t.changestatus,confirmation:t.confirmation}})]},proxy:!0},{key:"chat",fn:function(){return[s("mMessegeListRight",{directives:[{name:"show",rawName:"v-show",value:Object.keys(t.activedCh).length>0,expression:"Object.keys(activedCh).length>0"}],ref:"mychat",staticClass:"box2",attrs:{chatplace:"rightchat",header:!1,chat:t.activedCh,waiter:t.waiter},on:{waiting:function(e){t.waiter=!0}}})]},proxy:!0},{key:"filess",fn:function(){return[s("filelist",{attrs:{files:t.task.task_files,level:2,status:t.task.status.id,currentid:t.task.id},on:{uploadfile:t.uploadfile,deletefile:t.deletefile,VisSwitcher:t.VisSwitcher}})]},proxy:!0},{key:"graphic",fn:function(){return[s("work-pie-chart",{attrs:{title:"Статусы работ в задаче",data:t.task_statuses_calc}})]},proxy:!0}])})},i=[],n=s(56922),o=s(37505),r=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"gant"}},[s("div",{},[s("DxGantt",{ref:t.ganttRef,attrs:{"start-date-range":t.startDateRange,"end-date-range":t.endDateRange,"first-day-of-week":1,"task-list-width":150,height:350,"scale-type":t.scale,"task-content-template":"taskContentTemplate","task-tooltip-content-template":"TooltipContentTemplate","on-custom-command":t.onCustomCommandClick,"on-context-menu-preparing":t.onContextMenuPreparing},on:{"task-dbl-click":t.onTaskDblClick},scopedSlots:t._u([{key:"TooltipContentTemplate",fn:function(e){var a=e.data;return[s("div",{staticClass:"custom-task-edit-tooltip pa-2"},[s("div",{staticClass:"custom-tooltip-title"},[t._v('"'+t._s(a.title)+'"')]),s("div",[t._v(" Дата начала: "+t._s(a.start.toLocaleDateString())+" ")]),s("div",[t._v("Дата окончания: "+t._s(a.end.toLocaleDateString()))])])]}},{key:"taskContentTemplate",fn:function(e){var a=e.data;return[s("div",{staticClass:"custom-task",class:t.getTaskColor(a.taskData.id),style:{width:a.taskSize.width+"px"}},[s("div",{staticClass:"custom-task-wrapper"},[s("div",{staticClass:"custom-task-row"},[t._v(" "+t._s(a.taskData.title)+" -- "+t._s(a&&"taskResources"in a&&a.taskResources.length?a.taskResources[0].text:""))])])])]}}])},[s("DxContextMenu",{attrs:{items:t.contextMenuItems}}),s("DxScaleTypeRange",{attrs:{min:"days",max:"years"}}),s("DxToolbar",[s("DxItem",{scopedSlots:t._u([{key:"default",fn:function(){return[s("v-btn",{staticClass:"mx-auto px-auto pl-1",attrs:{icon:"","x-small":"",color:"btns"},on:{click:function(e){return e.stopPropagation(),t.$emit("changegantview")}}},[s("v-icon",{attrs:{color:"primary"}},[t._v("mdi-close")])],1)]},proxy:!0}])}),s("DxItem",{attrs:{name:"undo"}}),s("DxItem",{attrs:{name:"redo"}}),s("DxItem",{attrs:{name:"separator"}}),s("DxItem",{attrs:{name:"collapseAll"}}),s("DxItem",{attrs:{name:"expandAll"}}),s("DxItem",{attrs:{name:"separator"}}),s("DxItem",{attrs:{name:"zoomIn"}}),s("DxItem",{attrs:{name:"zoomOut"}}),s("DxItem",{attrs:{name:"fullScreen"}}),s("DxItem",{attrs:{name:"separator"}}),s("DxItem",{scopedSlots:t._u([{key:"default",fn:function(){return[s("v-btn",{staticClass:"inyand--text",attrs:{"x-small":"",color:"btns"},on:{click:function(e){return e.stopPropagation(),t.createnewTask.apply(null,arguments)}}},[t._v(" Создать работу")])]},proxy:!0}])})],1),s("DxTasks",{attrs:{"data-source":t.tasks}}),s("DxResources",{attrs:{"data-source":t.resources}}),s("DxResourceAssignments",{attrs:{"data-source":t.resourceAssignments}}),s("DxEditing",{attrs:{enabled:!1}}),t._v(" :allow-resource-adding = false :allow-resource-deleting = false "),s("DxColumn",{attrs:{"data-field":"title",caption:"",width:1}})],1)],1),s("v-dialog",{attrs:{"overlay-opacity":".1","max-width":"700px"},model:{value:t.dialog,callback:function(e){t.dialog=e},expression:"dialog"}},[s("DialogNewAssigment",{attrs:{text:t.actionmethod.text,height:350},scopedSlots:t._u([{key:"textarea",fn:function(){return[s("add-assigment",{attrs:{actionmethod:t.actionmethod,resources:t.resources,dialoginfo:t.dialoginfo},on:{changeddialog:t.changeddialog}})]},proxy:!0},{key:"btn1",fn:function(){return[s("BtnsOut",{attrs:{title:"Отмена"},on:{click:function(e){t.dialog=!1}}})]},proxy:!0},{key:"btn2",fn:function(){return[s("BtnsOut",{attrs:{title:"Сохранить"},on:{click:t.saveit}})]},proxy:!0}])})],1),s("v-dialog",{attrs:{"overlay-opacity":".1","max-width":"600px"},model:{value:t.deldialog,callback:function(e){t.deldialog=e},expression:"deldialog"}},[s("v-card",[s("v-card-title",[s("span",{staticClass:"text-h5"},[t._v(t._s(t.actionmethod.text))])]),s("v-card-text",[s("v-container",[s("v-row",[s("v-col",{attrs:{cols:"12"}},[t._v(' Вы уверены что хотите удалить "'+t._s(t.dialoginfo.name)+'"? Также будут удалены все связанные объекты ')])],1)],1)],1),s("v-card-actions",[s("v-spacer"),s("BtnsOut",{attrs:{title:"Отмена"},on:{click:function(e){t.deldialog=!1}}}),s("BtnsOut",{attrs:{title:"Подтвердить"},on:{click:t.saveit}})],1)],1)],1)],1)},d=[],l=s(76811),c=s(23575),h=s(20629),k=s(22233),m=s(24624),g=s(55188),u=s(4646);const p="gantt",w=(0,h._p)("projectstate"),f=(0,h._p)("taskstate"),v=(0,h._p)("workstate"),x=(0,h._p)("assignmentstate"),y=(0,h._p)("globalstore");var _={components:{DxScaleTypeRange:u.DxScaleTypeRange,Datepiker:l.Z,DxContextMenu:u.DxContextMenu,DxGantt:u.DxGantt,DxTasks:u.DxTasks,DxDependencies:u.DxDependencies,DxResources:u.DxResources,DxResourceAssignments:u.DxResourceAssignments,DxColumn:u.DxColumn,DxEditing:u.DxEditing,DxToolbar:u.DxToolbar,DxItem:u.DxItem,addAssigment:g.Z},mixins:[c.Z],data(){return{dialoginfo:{},scale:"year",selectedkey:"",ganttRef:p,actionmethod:{method:"addTask",text:"Создание работы",dateendstore:"",datestartstore:"",min:"",max:"",level:"task"},dialog:!1,deldialog:!1,tasks:[],task:[{name:"edittask",text:"Редактировать задачу"},{name:"addwork",text:"Создать Работу"}],work:[{name:"editwork",text:"Редактировать работу"},{name:"createAssignment",text:"Создать поручение"},{name:"delwork",text:"Удалить"}],asgmnt:[{name:"editasygmnt",text:"Редактировать поручение"},{name:"delasygmnt",text:"Удалить"}],contextMenuItems:[],resourceAssignments:[],disableContextMenu:!1}},created(){(0,m.EV)(k),(0,m.SP)(navigator.language)},computed:{gantt:function(){return this.scale=this.date_watch(this.startDateRange,this.endDateRange),this.$refs[p].instance},resources:{get(){return this.getprojectuniqueusers().filter((t=>6!=t.role.id))}},tasksOR(){return this.gettasks().task_work},startDateRange(){return this.tasks[0]?this.tasks[0].start:new Date},endDateRange(){return this.tasks[0]?this.tasks[0].end:new Date}},watch:{tasksOR(t){console.log("WTF");let e=this.topline(this.gettasks(),this.getTaskdatestart(),this.getTaskdateend());if(this.tasks=[e],this.resourceAssignments=[{id:-1,taskId:`parent-${this.gettasks().id}`,resourceId:this.getProjectrp().id}],t.length)for(let s=0;s<t.length;s++){this.tasks.push({id:`work-${t[s].id}`,title:t[s].name,parentId:this.tasks[0].id,start:new Date(t[s].datestart),end:new Date(t[s].dateend),status:t[s].status}),this.resourceAssignments.push({id:s,taskId:`work-${t[s].id}`,resourceId:t[s].responsible.id});let e=0;e++,t[s].work_assignment.forEach((e=>{this.tasks.push({id:`asgmnt-${e.id}`,title:e.name,parentId:`work-${t[s].id}`,start:new Date(e.datestart),end:new Date(e.dateend),status:e.status}),this.resourceAssignments.push({id:e.id+7e7,taskId:`asgmnt-${e.id}`,resourceId:e.responsible.id})}))}}},methods:{...y.mapMutations(["set_assign_id"]),...w.mapGetters(["getprojectuniqueusers","getprojectTasks","getprojectWorks","getProjectdatestart","getProjectdateend","getprojectIdName","getProjectrp","getProject"]),...f.mapGetters(["getTaskdatestart","getTaskdateend","gettasks"]),...f.mapMutations(["setTaskdateend","setTaskdatestart","settasks","settasksresponsible","settasksname"]),...v.mapGetters(["getWorkdatestart","getWorkdateend","getworks"]),...v.mapMutations(["setWorkdateend","setWorkdatestart","setWorks","setworksresponsible","setworksname"]),...x.mapGetters(["getAssignments","getAssignmentdatestart","getAssignmentdateend"]),...x.mapMutations(["setAssignments","setAssignmentname","setAssignmentdateend","setAssignmentdatestart","setAssignmentresponsible"]),createnewTask(){this.actionmethod={method:"creatework",level:"works",text:"Создание работы",responsible_text:"Ответственный",min:this.getTaskdatestart(),max:this.getTaskdateend(),datestartstore:"Workdatestart",dateendstore:"Workdateend"},this.setWorks({name:"",parent:Number(this.tasks[0].id.split("-")[1]),datestart:"",dateend:"",responsible:"",status:1}),this.dialoginfo=this.getworks(),this.dialog=!0},console(t){console.log(t)},onTaskDblClick(t){t.cancel=!0;let e=this.$route.path+"/work/";"parent"!=t.data.id.split("-")[0]&&("work"==t.data.id.split("-")[0]?e+=t.data.id.split("-")[1]:(e+=t.data.parentId.split("-")[1],this.set_assign_id(Number(t.data.id.split("-")[1]))),this.$router.push(e))},getTaskColor(t){let e=t.split("-")[1];const s=Number(e)%6;return`custom-task-color-${s}`},addwork(){this.createnewTask()},editwork(){let t=this.gettasks().task_work;console.log(t),this.setWorks(t[t.findIndex((t=>t.id==this.selectedkey.id.split("-")[1]&&this.selectedkey.title==t.name&&"work"==this.selectedkey.id.split("-")[0]))]),this.actionmethod={method:"editwork",level:"works",text:"Редактирование работы",responsible_text:"Ответственный",min:this.getTaskdatestart(),max:this.getTaskdateend(),datestartstore:"Workdatestart",dateendstore:"Workdateend"},this.dialoginfo=this.getworks(),this.dialog=!0},delwork(){let t=this.gettasks().task_work;this.setWorks(t[t.findIndex((t=>t.id==this.selectedkey.id.split("-")[1]&&this.selectedkey.title==t.name&&"work"==this.selectedkey.id.split("-")[0]))]),this.actionmethod={method:"delwork",level:"works",text:"Удаление работы",datestartstore:"Workdatestart",dateendstore:"Workdateend"},this.dialoginfo=this.getworks(),this.deldialog=!0},delasygmnt(){let t=[];this.gettasks().task_work.forEach((e=>{t=t.concat(e.work_assignment)})),this.setAssignments(t[t.findIndex((t=>t.id==this.selectedkey.id.split("-")[1]&&this.selectedkey.title==t.name&&"asgmnt"==this.selectedkey.id.split("-")[0]))]),this.actionmethod={method:"delasygmnt",level:"Assignments",text:"Удаление поручения",datestartstore:"Assignmentdatestart",dateendstore:"Assignmentdateend"},this.dialoginfo=this.getAssignments(),this.deldialog=!0},createAssignment(){let t=this.gettasks().task_work;this.setWorks(t[t.findIndex((t=>t.id==this.selectedkey.id.split("-")[1]&&"work"==this.selectedkey.id.split("-")[0]))]),this.setAssignments({name:"",parent:this.getworks().id,responsible:{},datestart:"",dateend:""}),this.dialoginfo=this.getAssignments(),this.actionmethod={method:"createasygmnt",level:"Assignments",text:"Создание поручения",responsible_text:"Исполнитель",min:this.getWorkdatestart(),max:this.getWorkdateend(),datestartstore:"Assignmentdatestart",dateendstore:"Assignmentdateend",responsible_text:"Исполнитель"},this.dialog=!0},editasygmnt(){let t=this.gettasks().task_work;this.setWorks(t[t.findIndex((t=>t.id==this.selectedkey.parentId.split("-")[1]&&"work"==this.selectedkey.parentId.split("-")[0]))]);let e=[];this.gettasks().task_work.forEach((t=>{e=e.concat(t.work_assignment)})),this.setAssignments(e[e.findIndex((t=>t.id==this.selectedkey.id.split("-")[1]&&this.selectedkey.title==t.name&&"asgmnt"==this.selectedkey.id.split("-")[0]))]),this.actionmethod={method:"editasygmnt",level:"Assignments",text:"Редактирование поручения",responsible_text:"Исполнитель",min:this.getWorkdatestart(),max:this.getWorkdateend(),datestartstore:"Assignmentdatestart",dateendstore:"Assignmentdateend"},this.dialoginfo=this.getAssignments(),this.dialog=!0}}},b=_,C=s(43736),D=s(43453),T=s.n(D),A=s(16190),I=s(34145),j=s(54886),$=s(60266),R=s(82118),Z=s(34061),W=s(4324),P=s(11713),S=s(13687),V=(0,C.Z)(b,r,d,!1,null,null,null),E=V.exports;T()(V,{VBtn:A.Z,VCard:I.Z,VCardActions:j.h7,VCardText:j.ZB,VCardTitle:j.EB,VCol:$.Z,VContainer:R.Z,VDialog:Z.Z,VIcon:W.Z,VRow:P.Z,VSpacer:S.Z});var M=s(45296),G=s(18241),O=s(1313),L=s(53502),N=s(10507),B=s(43803),z=s(54417),q=s(54355),J=s(87941);const F=(0,h._p)("assignmentstate"),U=(0,h._p)("projectstate"),X=(0,h._p)("taskstate"),H=(0,h._p)("workstate");var K={name:"task",mixins:[G.Z,O.Z],components:{Cards:o.Z,GantTask:E,filelist:L.Z,informationorders:N.Z,mMessegeListRight:B.Z,workPieChart:z.Z,WorkTaskAssProject:q["default"],LeftList:J.Z},data(){return{waiter:!1,activedCh:{},gantview:!1,chatview:!0,project:{name:"",status:{id:0,name:""},task:{name:"",datestart:"",dateend:"",responsible:{id:""}},users:[{role:{id:0},user:{id:0}}]},breadcrumbs:[{href:"",disabled:!0,text:""}],task:{name:"",task_work:[],datestart:"",dateend:"",responsible:{id:""},status:{id:0,name:""},description:""},show:!0,level:2,workaccepted:0,executed:0}},async mounted(){this.ws=new this.$pws,this.ws.start(this.$route.fullPath),this.ws.addEvent("onmessage",(t=>{const e=JSON.parse(t.data);if(console.log(e,"data"),"action"in e)try{this[e.action](e.payload)}catch(s){console.log(s)}else console.log(e)}))},computed:{...H.mapGetters(["getworks"]),...X.mapGetters(["gettasks"]),...F.mapGetters(["getAssignments"]),...U.mapGetters(["getProject","getprojectuniqueusers"]),task_statuses_calc(){return this.pie_statuses_calc(this.task.task_work)}},methods:{...X.mapMutations(["settasks"]),...U.mapMutations(["setProject","clearProject"]),renew(t){this.ws.stop(),console.log("aaaaad"),this.ws.start(this.$route.fullPath)},changestatus(t){let e="taskstatus",s={id:t.val.id,status:t.action,comment:t.comment,h_action:t.h_action};this.ws.send({action:e,payload:s})},changegantview(){this.gantview=!1},fileupdated(t){let e=this.task.task_files.findIndex((e=>e.id==t.id));this.task.task_files[e].visible=t.visible.split("")},newmessageincome(t){this.activedCh.lastmessage.push(t),this.$refs.mychat.scrollbottom(t.id)},rout(t){this.$router.push({path:`${this.$route.fullPath}/work/${t}`})},async uploadfile(t){let e={project:this.getProject.id,task:this.task.id,visible:"0100"};t.append("info",JSON.stringify(e));let s=await M.be.post("/main/uploader",t,{headers:{"Content-Type":"multipart/form-data"}});"created"in s.data&&this.ws.send({action:"fileuploaded",payload:this.task.id})},filerenew(t){t.forEach(((e,s)=>t[s].visible=e.visible.split(""))),this.task.task_files=t},build(t){console.log("BUILD",t),t.task.task_files.forEach(((e,s)=>t.task.task_files[s].visible=e.visible.split(""))),this.project=t.project,this.task=t.task,console.log("this.project",this.project),console.log("this.task",this.task),this.setProject(this.project),this.breadcrumbs=[{text:this.getProject.name,disabled:!1,href:`/project/${this.getProject.id}`}];let e=0;this.executed=t.task.task_work.filter((t=>5==t.status.id)).length,console.log(this.executed,"this.executed"),t.task.task_work.forEach((t=>{5==t.status.id&&(e+=1)})),this.workaccepted=e/t.task.task_work.length*100,this.settasks(t.task),"datachat"in t&&(this.activedCh=t.datachat,this.chatview="id"in this.activedCh,this.$refs.mychat.scrollbottom(this.activedCh.lastmessage[this.activedCh.lastmessage.length-1].id))},messagedeleted(t){try{let e=this.activedCh.lastmessage.findIndex((e=>e.id==t.id));this.activedCh.lastmessage.splice(e,1),console.log(this.activedCh.lastmessage,"slice")}catch{}},takeprev(t){this.activedCh.lastmessage.length<20?(this.activedCh.lastmessage=t.res,this.activedCh.lastmessage=this.activedCh.lastmessage):this.activedCh.lastmessage=t.res.concat(this.activedCh.lastmessage),this.waiter=!1},afterEnter(){console.log("@after-enter=")},afterLeave(){console.log("afterLeave"),this.tab=this.nedotab,this.currentid=0==this.tab?this.work.id:this.work.work_assignment[this.tab-1].id,this.activeChat(),this.show=!0},VisSwitcher(t){console.log("VisSwitcher",t),this.ws.send({action:"updateFile",payload:{id:t.id,visible:t.visible.join("")}})},rebuild(){this.ws.send({action:"rebuild",payload:this.task.id})},filedeleted(t){console.log("pl");let e=this.task.task_files.findIndex((e=>e.id==t.id));this.task.task_files.splice(e,1)},chatviewer(){this.chatview=!this.chatview},createtabchat(){let t=this.task.name,e=2,s=this.task.id,a=new Set;this.task.task_work.forEach((t=>a.add(t.responsible.id))),a.add(this.task.responsible.id),n.$.$emit("supogrammchatcreate",{users:Array.from(a),name:t,level:e,parent:s})},async uploadfile(t){let e={project:this.getProject.id,task:this.task.id,visible:"0100"};t.append("info",JSON.stringify(e));let s=await M.be.post("/main/uploader",t,{headers:{"Content-Type":"multipart/form-data"}});"created"in s.data&&this.ws.send({action:"fileuploaded",payload:this.task.id})},createnewWork(){this.$refs.ganttask.createnewTask()},gantviewer(){this.gantview=!this.gantview,this.gantview&&this.$refs.ganttask.rebuild()},addTask(t){console.log(t),delete t.val.history,this.ws.send({action:t.am.method,payload:t.val})},confirmation(t){this.task.task_work.forEach((t=>{t.menu=!1,t.action_confirm=!1})),t["task_status_update"]=this.task.task_work.every((e=>e.id==t.id&&5==t.status||5==e.status.id))?{res:!0}:{res:!1},this.ws.send({action:"confirmation",payload:t})}},beforeDestroy(){this.clearProject()}},Q=K,Y=s(99223),tt=s(77394),et=(0,C.Z)(Q,a,i,!1,null,null,null),st=et.exports;T()(et,{VCard:I.Z,VCol:$.Z,VDivider:Y.Z,VRow:P.Z,VSlideXReverseTransition:tt.Zy})}}]);
//# sourceMappingURL=501.660786ff.js.map